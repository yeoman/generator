

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: util/conflicter.js | Generator</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 127px; height: 14px">
        
            <img src="https://raw.githubusercontent.com/yeoman/yeoman.github.io/source/app/assets/img/logo.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Generator</a></h1>
        
            <span class="version">v4.5.0</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-promptSuggestion.html">promptSuggestion</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:promptSuggestion_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="Conflicter.html">Conflicter</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Conflicter_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Conflicter.html#_detectConflict">_detectConflict</a></li><li><a href="Conflicter.html#_printDiff">_printDiff</a></li><li><a href="Conflicter.html#checkForCollision">checkForCollision</a></li><li><a href="Conflicter.html#collision">collision</a></li><li><a href="Conflicter.html#resolve">resolve</a></li></ul></div></li><li><a href="Generator.html">Generator</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Generator_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Generator.html#argument">argument</a></li><li><a href="Generator.html#argumentsHelp">argumentsHelp</a></li><li><a href="Generator.html#argumentsHelp">argumentsHelp</a></li><li><a href="Generator.html#bowerInstall">bowerInstall</a></li><li><a href="Generator.html#bowerInstall">bowerInstall</a></li><li><a href="Generator.html#composeWith">composeWith</a></li><li><a href="Generator.html#debug">debug</a></li><li><a href="Generator.html#desc">desc</a></li><li><a href="Generator.html#desc">desc</a></li><li><a href="Generator.html#destinationPath">destinationPath</a></li><li><a href="Generator.html#destinationRoot">destinationRoot</a></li><li><a href="Generator.html#determineAppname">determineAppname</a></li><li><a href="Generator.html#git.email">git.email</a></li><li><a href="Generator.html#git.email">git.email</a></li><li><a href="Generator.html#help">help</a></li><li><a href="Generator.html#help">help</a></li><li><a href="Generator.html#installDependencies">installDependencies</a></li><li><a href="Generator.html#installDependencies">installDependencies</a></li><li><a href="Generator.html#git.name">git.name</a></li><li><a href="Generator.html#git.name">git.name</a></li><li><a href="Generator.html#npmInstall">npmInstall</a></li><li><a href="Generator.html#npmInstall">npmInstall</a></li><li><a href="Generator.html#option">option</a></li><li><a href="Generator.html#optionsHelp">optionsHelp</a></li><li><a href="Generator.html#optionsHelp">optionsHelp</a></li><li><a href="Generator.html#prompt">prompt</a></li><li><a href="Generator.html#queueMethod">queueMethod</a></li><li><a href="Generator.html#registerTransformStream">registerTransformStream</a></li><li><a href="Generator.html#rootGeneratorName">rootGeneratorName</a></li><li><a href="Generator.html#rootGeneratorVersion">rootGeneratorVersion</a></li><li><a href="Generator.html#run">run</a></li><li><a href="Generator.html#scheduleInstallTask">scheduleInstallTask</a></li><li><a href="Generator.html#scheduleInstallTask">scheduleInstallTask</a></li><li><a href="Generator.html#sourceRoot">sourceRoot</a></li><li><a href="Generator.html#spawnCommand">spawnCommand</a></li><li><a href="Generator.html#spawnCommand">spawnCommand</a></li><li><a href="Generator.html#spawnCommandSync">spawnCommandSync</a></li><li><a href="Generator.html#spawnCommandSync">spawnCommandSync</a></li><li><a href="Generator.html#templatePath">templatePath</a></li><li><a href="Generator.html#usage">usage</a></li><li><a href="Generator.html#usage">usage</a></li><li><a href="Generator.html#github.username">github.username</a></li><li><a href="Generator.html#github.username">github.username</a></li><li><a href="Generator.html#yarnInstall">yarnInstall</a></li><li><a href="Generator.html#yarnInstall">yarnInstall</a></li></ul></div></li><li><a href="Storage.html">Storage</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Storage_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Storage.html#defaults">defaults</a></li><li><a href="Storage.html#delete">delete</a></li><li><a href="Storage.html#get">get</a></li><li><a href="Storage.html#getAll">getAll</a></li><li><a href="Storage.html#save">save</a></li><li><a href="Storage.html#set">set</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Mixins</h3><ul><li><a href="actions_help.html">actions/help</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="actions/help_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="actions_help.html#.argumentsHelp">argumentsHelp</a></li><li><a href="actions_help.html#.desc">desc</a></li><li><a href="actions_help.html#.help">help</a></li><li><a href="actions_help.html#.optionsHelp">optionsHelp</a></li><li><a href="actions_help.html#.usage">usage</a></li></ul></div></li><li><a href="actions_install.html">actions/install</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="actions/install_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="actions_install.html#.bowerInstall">bowerInstall</a></li><li><a href="actions_install.html#.installDependencies">installDependencies</a></li><li><a href="actions_install.html#.npmInstall">npmInstall</a></li><li><a href="actions_install.html#.scheduleInstallTask">scheduleInstallTask</a></li><li><a href="actions_install.html#.yarnInstall">yarnInstall</a></li></ul></div></li><li><a href="actions_spawn-command.html">actions/spawn-command</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="actions/spawn-command_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="actions_spawn-command.html#.spawnCommand">spawnCommand</a></li><li><a href="actions_spawn-command.html#.spawnCommandSync">spawnCommandSync</a></li></ul></div></li><li><a href="actions_user.html">actions/user</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="actions/user_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="actions_user.html#.git.email">git.email</a></li><li><a href="actions_user.html#.git.name">git.name</a></li><li><a href="actions_user.html#.github.username">github.username</a></li></ul></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const fs = require('fs');
const path = require('path');
const async = require('async');
const jsdiff = require('diff');
const _ = require('lodash');
const typedError = require('error/typed');
const binaryDiff = require('./binary-diff');

const AbortedError = typedError({
  type: 'AbortedError',
  message: 'Process aborted by user'
});

const ConflictError = typedError({
  type: 'ConflicterConflict',
  message: 'Process aborted by conflict'
});

/**
 * The Conflicter is a module that can be used to detect conflict between files. Each
 * Generator file system helpers pass files through this module to make sure they don't
 * break a user file.
 *
 * When a potential conflict is detected, we prompt the user and ask them for
 * confirmation before proceeding with the actual write.
 *
 * @constructor
 * @property {Boolean} force - same as the constructor argument
 *
 * @param  {TerminalAdapter} adapter - The generator adapter
 * @param  {Boolean} force - When set to true, we won't check for conflict. (the
 *                           conflicter become a passthrough)
 * @param  {Boolean} bail - When set to true, we will abort on first conflict. (used for
 *                           testing reproducibility)
 */
class Conflicter {
  constructor(adapter, force, options = {}) {
    if (typeof options === 'boolean') {
      this.bail = options;
    } else {
      this.bail = options.bail;
      this.ignoreWhitespace = options.ignoreWhitespace;
      this.skipRegenerate = options.skipRegenerate;
      this.dryRun = options.dryRun;
    }

    this.force = force === true;
    this.adapter = adapter;
    this.conflicts = [];

    this.diffOptions = options.diffOptions;

    if (this.bail) {
      // Set ignoreWhitespace as true by default for bail.
      // Probably just testing, so don't override.
      this.ignoreWhitespace = true;
      this.skipRegenerate = true;
    }

    if (this.dryRun) {
      // Ignore whitespace changes with "ignoreWhitespace === true" option
      this.skipRegenerate = true;
    }
  }

  /**
   * Add a file to conflicter queue
   *
   * @param {String} filepath - File destination path
   * @param {String} contents - File new contents
   * @param {Function} callback - callback to be called once we know if the user want to
   *                              proceed or not.
   */
  checkForCollision(filepath, contents, callback) {
    this.conflicts.push({
      file: {
        path: path.resolve(filepath),
        contents
      },
      callback
    });
  }

  /**
   * Process the _potential conflict_ queue and ask the user to resolve conflict when they
   * occur
   *
   * The user is presented with the following options:
   *
   *   - `Y` Yes, overwrite
   *   - `n` No, do not overwrite
   *   - `a` All, overwrite this and all others
   *   - `x` Exit, abort
   *   - `d` Diff, show the differences between the old and the new
   *   - `h` Help, show this help
   *
   * @param  {Function} cb Callback once every conflict are resolved. (note that each
   *                       file can specify it's own callback. See `#checkForCollision()`)
   */
  resolve(cb) {
    cb = cb || (() => {});

    const resolveConflicts = conflict => {
      return next => {
        if (!conflict) {
          next();
          return;
        }

        this.collision(conflict.file, status => {
          // Remove the resolved conflict from the queue
          _.pull(this.conflicts, conflict);
          conflict.callback(null, status);
          next();
        });
      };
    };

    async.series(this.conflicts.map(resolveConflicts), cb.bind(this));
  }

  /**
   * Print the file differences to console
   *
   * @param  {Object}   file File object respecting this interface: { path, contents }
   */
  _printDiff(file) {
    if (file.binary === undefined) {
      file.binary = binaryDiff.isBinary(file.path, file.contents);
    }

    if (file.binary) {
      this.adapter.log.writeln(binaryDiff.diff(file.path, file.contents));
    } else {
      const existing = fs.readFileSync(file.path);
      this.adapter.diff(
        existing.toString(),
        (file.contents || '').toString(),
        file.changes
      );
    }
  }

  /**
   * Detect conflicts between file contents at `filepath` with the `contents` passed to the
   * function
   *
   * If `filepath` points to a folder, we'll always return true.
   *
   * Based on detect-conflict module
   *
   * @param  {Object}   file File object respecting this interface: { path, contents }
   * @return {Boolean} `true` if there's a conflict, `false` otherwise.
   */
  _detectConflict(file) {
    let contents = file.contents;
    const filepath = path.resolve(file.path);

    // If file path point to a directory, then it's not safe to write
    if (fs.statSync(filepath).isDirectory()) return true;

    if (file.binary === undefined) {
      file.binary = binaryDiff.isBinary(file.path, file.contents);
    }

    const actual = fs.readFileSync(path.resolve(filepath));

    if (!(contents instanceof Buffer)) {
      contents = Buffer.from(contents || '', 'utf8');
    }

    if (file.binary) {
      return actual.toString('hex') !== contents.toString('hex');
    }

    if (this.ignoreWhitespace) {
      file.changes = jsdiff.diffWords(
        actual.toString(),
        contents.toString(),
        this.diffOptions
      );
    } else {
      file.changes = jsdiff.diffLines(
        actual.toString(),
        contents.toString(),
        this.diffOptions
      );
    }

    const changes = file.changes;
    return changes.length > 1 || changes[0].added || changes[0].removed;
  }

  /**
   * Check if a file conflict with the current version on the user disk
   *
   * A basic check is done to see if the file exists, if it does:
   *
   *   1. Read its content from  `fs`
   *   2. Compare it with the provided content
   *   3. If identical, mark it as is and skip the check
   *   4. If diverged, prepare and show up the file collision menu
   *
   * @param  {Object}   file File object respecting this interface: { path, contents }
   * @param  {Function} cb Callback receiving a status string ('identical', 'create',
   *                       'skip', 'force')
   */
  collision(file, cb) {
    const rfilepath = path.relative(process.cwd(), file.path);

    if (!fs.existsSync(file.path)) {
      this.adapter.log.create(rfilepath);
      if (this.bail) {
        this.adapter.log.writeln('Aborting ...');
        throw new ConflictError();
      }

      if (this.dryRun) {
        cb('skip');
        return;
      }

      cb('create');
      return;
    }

    if (this.force) {
      this.adapter.log.force(rfilepath);
      cb('force');
      return;
    }

    if (this._detectConflict(file)) {
      this.adapter.log.conflict(rfilepath);
      if (this.bail) {
        this._printDiff(file);
        this.adapter.log.writeln('Aborting ...');
        throw new ConflictError();
      }

      if (this.dryRun) {
        this._printDiff(file);
        cb('skip');
        return;
      }

      this._ask(file, cb);
    } else {
      this.adapter.log.identical(rfilepath);
      if (this.skipRegenerate) {
        cb('skip');
      } else {
        cb('identical');
      }
    }
  }

  /**
   * Actual prompting logic
   * @private
   * @param {Object} file vinyl file object
   * @param {Function} cb callback receiving the next action
   */
  _ask(file, cb) {
    const rfilepath = path.relative(process.cwd(), file.path);
    const prompt = {
      name: 'action',
      type: 'expand',
      message: `Overwrite ${rfilepath}?`,
      choices: [
        {
          key: 'y',
          name: 'overwrite',
          value: 'write'
        },
        {
          key: 'n',
          name: 'do not overwrite',
          value: 'skip'
        },
        {
          key: 'a',
          name: 'overwrite this and all others',
          value: 'force'
        },
        {
          key: 'x',
          name: 'abort',
          value: 'abort'
        }
      ]
    };

    // Only offer diff option for files
    if (fs.statSync(file.path).isFile()) {
      prompt.choices.push({
        key: 'd',
        name: 'show the differences between the old and the new',
        value: 'diff'
      });
    }

    this.adapter.prompt([prompt], result => {
      if (result.action === 'abort') {
        this.adapter.log.writeln('Aborting ...');
        throw new AbortedError();
      }

      if (result.action === 'diff') {
        this._printDiff(file);

        return this._ask(file, cb);
      }

      if (result.action === 'force') {
        this.force = true;
      }

      if (result.action === 'write') {
        result.action = 'force';
      }

      this.adapter.log[result.action || 'force'](rfilepath);
      return cb(result.action);
    });
  }
}

module.exports = Conflicter;
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://raw.githubusercontent.com/yeoman/yeoman.github.io/source/app/assets/img/logo.png" style="width: 127px; height: 14px">
    <div class="footer-text">BSD license Copyright (c) Google</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
